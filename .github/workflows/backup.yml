name: Backup Releases

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'   # æ¯å¤© åŒ—äº¬æ—¶é—´ 8:00 æ‰§è¡Œ

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Process each repo
        run: |
          # éå† backup-repos.urlï¼Œå¿½ç•¥ç©ºè¡Œå’Œæ³¨é‡Š
          grep -vE '^\s*#|^\s*$' backup-repos.url | while read -r url; do
            url=$(echo "$url" | xargs)  # å»æ‰å‰åç©ºæ ¼
            echo "Processing URL: $url"

            # ========== 1. è§£æ URL ==========
            # å»æ‰ query å‚æ•° å’Œ æœ«å°¾æ–œæ 
            clean_url=$(echo "$url" | sed 's/[?#].*$//' | sed 's:/*$::')

            # æå– github.com/ åçš„è·¯å¾„
            path=$(echo "$clean_url" | sed -n 's|.*github.com/\(.*\)|\1|p')

            # åˆ†å‰² path
            IFS='/' read -r owner name maybe_tree branch <<<"$path"

            # å¦‚æœæ²¡æœ‰ treeï¼Œå°±æ¸…ç©º branch
            if [ "$maybe_tree" != "tree" ]; then
              branch=""
            fi

            if [ -z "$owner" ] || [ -z "$name" ]; then
              echo "âš ï¸ æ— æ³•è§£æ $url, è·³è¿‡."
              continue
            fi

            echo "=== Processing $owner/$name (branch: ${branch:-default}) ==="

            # ========== 2. æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨ ==========
            repo_info=$(gh api repos/$owner/$name 2>/dev/null || true)
            if [ -z "$repo_info" ]; then
              echo "âš ï¸ ä»“åº“ $owner/$name ä¸å­˜åœ¨æˆ–å·²åˆ é™¤ï¼Œè·³è¿‡."
              continue
            fi

            # ========== 3. è·å– release ==========
            release=$(gh api repos/$owner/$name/releases/latest 2>/dev/null || true)
            message=$(echo "$release" | jq -r '.message // empty')

            if [ -n "$release" ] && [ "$message" != "Not Found" ]; then
              # æœ‰ release
              tag=$(echo "$release" | jq -r '.tag_name')
              tarball=$(echo "$release" | jq -r '.tarball_url')
              zipball=$(echo "$release" | jq -r '.zipball_url')
              assets=$(echo "$release" | jq -c '.assets')

              path="releases/$owner/$name/$tag"
              if [ -d "$path" ]; then
                echo "âœ… Release $owner/$name@$tag å·²å­˜åœ¨ï¼Œè·³è¿‡."
                continue
              fi

              mkdir -p "$path"

              echo "â¬‡ï¸ ä¸‹è½½ release tarball & zip..."
              curl -sSL "$tarball" -o "$path/source.tar.gz" || true
              curl -sSL "$zipball" -o "$path/source.zip" || true

              echo "$assets" | jq -c '.[]' | while read -r asset; do
                url=$(echo "$asset" | jq -r '.browser_download_url')
                fname=$(echo "$asset" | jq -r '.name')
                echo "â¬‡ï¸ ä¸‹è½½èµ„æº: $fname"
                curl -sSL "$url" -o "$path/$fname" || true
              done

            else
              # ========== 4. æ²¡æœ‰ releaseï¼Œä¸‹è½½æŒ‡å®šåˆ†æ”¯ ==========
              if [ -z "$branch" ]; then
                branch=$(echo "$repo_info" | jq -r '.default_branch')
              fi

              safe_branch=$(echo "$branch" | tr '/' '-')

              echo "â„¹ï¸ æ²¡æœ‰ releaseï¼Œå¤‡ä»½åˆ†æ”¯: $branch"

              commit=$(gh api repos/$owner/$name/commits/$branch --jq '.sha' 2>/dev/null || true)
              if [ -z "$commit" ]; then
                echo "âš ï¸ åˆ†æ”¯ $branch ä¸å­˜åœ¨ï¼Œè·³è¿‡."
                continue
              fi

              short_commit=${commit:0:7}
              path="releases/$owner/$name/${safe_branch}/$short_commit"
              if [ -d "$path" ]; then
                echo "âœ… åˆ†æ”¯å¤‡ä»½ $owner/$name@$branch@$short_commit å·²å­˜åœ¨ï¼Œè·³è¿‡."
                continue
              fi

              mkdir -p "$path"
              curl -sSL "https://github.com/$owner/$name/archive/$commit.tar.gz" -o "$path/$short_commit.tar.gz" || true
              curl -sSL "https://github.com/$owner/$name/archive/$commit.zip" -o "$path/$short_commit.zip" || true
            fi
          done

      - name: Generate backup-repos.md
        run: |
          md_file="backup-repos.md"
          txt_file="backup-repos.url"

          # è·å– backup-repos.url çš„ä¿®æ”¹æ—¶é—´
          txt_time=$(stat -c %Y "$txt_file")
          md_time=0
          if [ -f "$md_file" ]; then
            md_time=$(stat -c %Y "$md_file")
          fi

          if [ ! -f "$md_file" ] || [ "$txt_time" -gt "$md_time" ]; then
            echo "# ğŸ“¦ Backup Repositories" > "$md_file"
            echo "" >> "$md_file"
            echo "ä¸‹é¢æ˜¯æ‰€æœ‰æ­£åœ¨å¤‡ä»½çš„ GitHub ä»“åº“ï¼Œä»¥åŠå®ƒä»¬çš„å…³é”®ä¿¡æ¯ã€‚" >> "$md_file"
            echo "" >> "$md_file"
            echo "| ä»“åº“ | æè¿° | Star | Fork | æœ€è¿‘æ›´æ–° |" >> "$md_file"
            echo "|------|------|------|------|----------|" >> "$md_file"

            grep -vE '^\s*#|^\s*$' "$txt_file" | while read -r url; do
              url=$(echo "$url" | xargs)
              clean_url=$(echo "$url" | sed 's/[?#].*$//' | sed 's:/*$::')
              path=$(echo "$clean_url" | sed -n 's|.*github.com/\(.*\)|\1|p')
              IFS='/' read -r owner name _ <<<"$path"

              repo_info=$(gh api repos/$owner/$name 2>/dev/null || true)
              if [ -n "$repo_info" ]; then
                desc=$(echo "$repo_info" | jq -r '.description // "-"')
                stars=$(echo "$repo_info" | jq -r '.stargazers_count')
                forks=$(echo "$repo_info" | jq -r '.forks_count')
                updated=$(echo "$repo_info" | jq -r '.updated_at' | cut -d'T' -f1)
                echo "| [$owner/$name](https://github.com/$owner/$name) | $desc | â­ $stars | ğŸ´ $forks | $updated |" >> "$md_file"
              else
                echo "| [$owner/$name](https://github.com/$owner/$name) | âŒ ä»“åº“ä¸å­˜åœ¨ | - | - | - |" >> "$md_file"
              fi
            done
          else
            echo "âš ï¸ backup-repos.md å·²ç»æ˜¯æœ€æ–°çš„ï¼Œè·³è¿‡ç”Ÿæˆ."
          fi

      - name: Commit and push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "Backup new releases & update repo list [skip ci]" || echo "No changes"
          git push
